{% extends 'hostels/base.html' %}
{% load static %}

{% block title %}
    {% if object %}Edit Room Type{% else %}Add Room Type{% endif %} - StudentStay
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --airbnb-red: #FF385C;
        --airbnb-dark: #222222;
        --airbnb-gray: #717171;
        --airbnb-light-gray: #F7F7F7;
        --airbnb-border: #DDDDDD;
    }

    .form-container {
        background: white;
        border-radius: 12px;
        box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        margin: 2rem 0;
    }

    .form-header {
        padding: 2rem 2rem 1rem;
        border-bottom: 1px solid var(--airbnb-border);
        background: linear-gradient(135deg, var(--airbnb-red) 0%, #E31C5F 100%);
        color: white;
        border-radius: 12px 12px 0 0;
    }

    .form-title {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .form-subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
    }

    .form-body {
        padding: 2rem;
    }

    .form-section {
        margin-bottom: 3rem;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--airbnb-dark);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .section-icon {
        width: 24px;
        height: 24px;
        color: var(--airbnb-red);
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-label {
        font-weight: 600;
        color: var(--airbnb-dark);
        margin-bottom: 0.5rem;
        display: block;
    }

    .form-control, .form-select {
        border: 1px solid var(--airbnb-border);
        border-radius: 8px;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        transition: border-color 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--airbnb-dark);
        box-shadow: 0 0 0 2px rgba(34, 34, 34, 0.1);
    }

    .room-type-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .room-type-card {
        border: 2px solid var(--airbnb-border);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }

    .room-type-card:hover {
        border-color: var(--airbnb-red);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }

    .room-type-card.selected {
        border-color: var(--airbnb-red);
        background: rgba(255, 56, 92, 0.05);
    }

    .room-type-icon {
        font-size: 2.5rem;
        color: var(--airbnb-red);
        margin-bottom: 1rem;
    }

    .room-type-title {
        font-weight: 600;
        color: var(--airbnb-dark);
        margin-bottom: 0.5rem;
    }

    .room-type-desc {
        color: var(--airbnb-gray);
        font-size: 0.9rem;
    }

    .image-upload-zone {
        border: 2px dashed var(--airbnb-border);
        border-radius: 12px;
        padding: 3rem 2rem;
        text-align: center;
        background: var(--airbnb-light-gray);
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .image-upload-zone:hover {
        border-color: var(--airbnb-red);
        background: rgba(255, 56, 92, 0.05);
    }

    .image-upload-zone.dragover {
        border-color: var(--airbnb-red);
        background: rgba(255, 56, 92, 0.1);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 3rem;
        color: var(--airbnb-gray);
        margin-bottom: 1rem;
    }

    .upload-text {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--airbnb-dark);
        margin-bottom: 0.5rem;
    }

    .upload-subtext {
        color: var(--airbnb-gray);
        font-size: 0.9rem;
    }

    .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1.5rem;
    }

    .image-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        aspect-ratio: 1;
        background: var(--airbnb-light-gray);
    }

    .image-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .image-remove {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: rgba(0,0,0,0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease;
    }

    .image-remove:hover {
        background: var(--airbnb-red);
    }

    .image-main-badge {
        position: absolute;
        bottom: 0.5rem;
        left: 0.5rem;
        background: var(--airbnb-red);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .room-numbers-input {
        background: var(--airbnb-light-gray);
        padding: 1.5rem;
        border-radius: 8px;
        margin-top: 1rem;
    }

    .room-number-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .room-tag {
        background: var(--airbnb-red);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .room-tag-remove {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        padding: 0;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .room-tag-remove:hover {
        background: rgba(255,255,255,0.2);
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .feature-card {
        border: 1px solid var(--airbnb-border);
        border-radius: 8px;
        padding: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .feature-card:hover {
        border-color: var(--airbnb-dark);
    }

    .feature-card.selected {
        border-color: var(--airbnb-red);
        background: rgba(255, 56, 92, 0.05);
    }

    .feature-icon {
        font-size: 1.25rem;
        color: var(--airbnb-red);
    }

    .feature-label {
        font-weight: 500;
        color: var(--airbnb-dark);
    }

    .price-input-group {
        position: relative;
    }

    .price-input-group .form-control {
        padding-left: 2.5rem;
    }

    .price-symbol {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--airbnb-gray);
        font-weight: 600;
    }

    .submit-section {
        background: var(--airbnb-light-gray);
        padding: 2rem;
        border-top: 1px solid var(--airbnb-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 12px 12px;
    }

    .btn-primary {
        background: var(--airbnb-red);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
    }

    .btn-primary:hover {
        background: #E31C5F;
    }

    .btn-outline-secondary {
        border-color: var(--airbnb-border);
        color: var(--airbnb-dark);
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
    }

    .error-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .help-text {
        color: var(--airbnb-gray);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .progress-indicator {
        display: flex;
        justify-content: center;
        margin-bottom: 2rem;
    }

    .progress-step {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--airbnb-gray);
    }

    .progress-step.active {
        color: var(--airbnb-red);
        font-weight: 600;
    }

    .step-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--airbnb-border);
        color: var(--airbnb-gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
    }

    .step-number.active {
        background: var(--airbnb-red);
        color: white;
    }

    .step-connector {
        width: 40px;
        height: 2px;
        background: var(--airbnb-border);
        margin: 0 1rem;
    }

    @media (max-width: 768px) {
        .form-body {
            padding: 1rem;
        }
        
        .room-type-selector {
            grid-template-columns: 1fr;
        }
        
        .feature-grid {
            grid-template-columns: 1fr;
        }
        
        .submit-section {
            flex-direction: column;
            gap: 1rem;
        }
        
        .progress-indicator {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="form-container">
                <div class="form-header">
                    <h1 class="form-title">
                        {% if object %}
                            Edit Room Type
                        {% else %}
                            Add Room Type
                        {% endif %}
                    </h1>
                    <p class="form-subtitle">
                        {% if object %}
                            Update the details of your room type
                        {% else %}
                            Define the types of rooms available in your property
                        {% endif %}
                    </p>
                </div>

                <form method="post" enctype="multipart/form-data" id="roomTypeForm">
                    {% csrf_token %}
                    
                    <div class="form-body">
                        <!-- Property Selection (if creating new) -->
                        {% if not object %}
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-building section-icon"></i>
                                Property Selection
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label" for="{{ form.hostel.id_for_label }}">
                                    Select Property *
                                </label>
                                {{ form.hostel }}
                                {% if form.hostel.errors %}
                                    <div class="error-message">{{ form.hostel.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Room Type & Basic Info -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-bed section-icon"></i>
                                Room Configuration
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label">Number of Beds per Room *</label>
                                <div class="room-type-selector">
                                    <div class="room-type-card" data-beds="1">
                                        <div class="room-type-icon">
                                            <i class="fas fa-bed"></i>
                                        </div>
                                        <div class="room-type-title">Single Room</div>
                                        <div class="room-type-desc">1 bed per room</div>
                                    </div>
                                    
                                    <div class="room-type-card" data-beds="2">
                                        <div class="room-type-icon">
                                            <i class="fas fa-bed"></i>
                                            <i class="fas fa-bed"></i>
                                        </div>
                                        <div class="room-type-title">Double Room</div>
                                        <div class="room-type-desc">2 beds per room</div>
                                    </div>
                                    
                                    <div class="room-type-card" data-beds="3">
                                        <div class="room-type-icon">
                                            <i class="fas fa-bed"></i>
                                            <i class="fas fa-bed"></i>
                                            <i class="fas fa-bed"></i>
                                        </div>
                                        <div class="room-type-title">Triple Room</div>
                                        <div class="room-type-desc">3 beds per room</div>
                                    </div>
                                    
                                    <div class="room-type-card" data-beds="4">
                                        <div class="room-type-icon">
                                            <i class="fas fa-bed"></i>
                                            <i class="fas fa-bed"></i>
                                            <i class="fas fa-bed"></i>
                                            <i class="fas fa-bed"></i>
                                        </div>
                                        <div class="room-type-title">Quad Room</div>
                                        <div class="room-type-desc">4 beds per room</div>
                                    </div>
                                </div>
                                
                                <!-- Hidden inputs -->
                                {{ form.beds_per_room }}
                                {{ form.room_type }}
                                
                                {% if form.beds_per_room.errors %}
                                    <div class="error-message">{{ form.beds_per_room.errors.0 }}</div>
                                {% endif %}
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label" for="{{ form.name.id_for_label }}">
                                            Room Type Name *
                                        </label>
                                        {{ form.name }}
                                        {% if form.name.errors %}
                                            <div class="error-message">{{ form.name.errors.0 }}</div>
                                        {% endif %}
                                        <div class="help-text">e.g., "Deluxe Single", "Standard Double"</div>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label" for="{{ form.total_rooms.id_for_label }}">
                                            Total Rooms of This Type *
                                        </label>
                                        {{ form.total_rooms }}
                                        {% if form.total_rooms.errors %}
                                            <div class="error-message">{{ form.total_rooms.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="{{ form.description.id_for_label }}">
                                    Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="error-message">{{ form.description.errors.0 }}</div>
                                {% endif %}
                                <div class="help-text">Describe what makes this room type special</div>
                            </div>
                        </div>

                        <!-- Room Numbers -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-door-open section-icon"></i>
                                Room Numbers
                            </h3>
                            
                            <div class="room-numbers-input">
                                <div class="form-group">
                                    <label class="form-label" for="{{ form.room_numbers.id_for_label }}">
                                        Room Numbers *
                                    </label>
                                    {{ form.room_numbers }}
                                    {% if form.room_numbers.errors %}
                                        <div class="error-message">{{ form.room_numbers.errors.0 }}</div>
                                    {% endif %}
                                    <div class="help-text">
                                        Enter room numbers separated by commas (e.g., 101,102,103)
                                    </div>
                                </div>
                                
                                <div id="roomNumberTags" class="room-number-tags"></div>
                            </div>
                        </div>

                        <!-- Pricing -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-dollar-sign section-icon"></i>
                                Pricing
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label" for="{{ form.price_per_person.id_for_label }}">
                                    Price per Person per Month *
                                </label>
                                <div class="price-input-group">
                                    <span class="price-symbol">GHS</span>
                                    {{ form.price_per_person }}
                                </div>
                                {% if form.price_per_person.errors %}
                                    <div class="error-message">{{ form.price_per_person.errors.0 }}</div>
                                {% endif %}
                                <div class="help-text">Set competitive pricing for your target market</div>
                            </div>
                        </div>

                        <!-- Room Features -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-star section-icon"></i>
                                Room Features
                            </h3>
                            
                            <div class="feature-grid">
                                <div class="feature-card" data-feature="private_bathroom">
                                    {{ form.has_private_bathroom }}
                                    <i class="fas fa-bath feature-icon"></i>
                                    <span class="feature-label">Private Bathroom</span>
                                </div>
                                
                                <div class="feature-card" data-feature="balcony">
                                    {{ form.has_balcony }}
                                    <i class="fas fa-building feature-icon"></i>
                                    <span class="feature-label">Balcony</span>
                                </div>
                                
                                <div class="feature-card" data-feature="ac">
                                    {{ form.has_ac }}
                                    <i class="fas fa-snowflake feature-icon"></i>
                                    <span class="feature-label">Air Conditioning</span>
                                </div>
                            </div>
                        </div>

                        <!-- Room Images -->
                        <div class="form-section">
                            <h3 class="section-title">
                                <i class="fas fa-camera section-icon"></i>
                                Room Images
                            </h3>
                            
                            <div class="form-group">
                                <label class="form-label" for="{{ form.main_image.id_for_label }}">
                                    Main Room Image
                                </label>
                                <div class="image-upload-zone" id="mainImageUpload">
                                    <input type="file" id="{{ form.main_image.id_for_label }}" name="{{ form.main_image.name }}" 
                                           accept="image/*" style="display: none;">
                                    <div class="upload-content">
                                        <i class="fas fa-cloud-upload-alt upload-icon"></i>
                                        <div class="upload-text">Upload Main Room Image</div>
                                        <div class="upload-subtext">JPG, PNG up to 10MB</div>
                                    </div>
                                </div>
                                <div id="mainImagePreview" class="image-grid"></div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="{{ form.images.id_for_label }}">
                                    Additional Room Images
                                </label>
                                <div class="image-upload-zone" id="additionalImagesUpload">
                                    <input type="file" id="{{ form.images.id_for_label }}" name="{{ form.images.name }}" 
                                           accept="image/*" multiple style="display: none;">
                                    <div class="upload-content">
                                        <i class="fas fa-images upload-icon"></i>
                                        <div class="upload-text">Upload Additional Images</div>
                                        <div class="upload-subtext">Select multiple files (JPG, PNG up to 10MB each)</div>
                                    </div>
                                </div>
                                <div id="additionalImagesPreview" class="image-grid"></div>
                                {% if form.images.errors %}
                                    <div class="error-message">{{ form.images.errors.0 }}</div>
                                {% endif %}
                                <div class="help-text">Show different angles and features of the room</div>
                            </div>
                        </div>
                    </div>

                    <div class="submit-section">
                        <div>
                            <a href="{% if object %}{% url 'hostels:hostel-detail' slug=object.hostel.slug %}{% else %}{% url 'hostels:dashboard' %}{% endif %}" 
                               class="btn btn-outline-secondary">
                                Cancel
                            </a>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                {% if object %}
                                    Update Room Type
                                {% else %}
                                    Add Room Type
                                {% endif %}
                                <i class="fas fa-check ms-2"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Room type selection
    const roomTypeCards = document.querySelectorAll('.room-type-card');
    const bedsInput = document.getElementById('{{ form.beds_per_room.id_for_label }}');
    const roomTypeInput = document.getElementById('{{ form.room_type.id_for_label }}');
    
    // Room type mapping
    const typeMapping = {
        1: 'single',
        2: 'double',
        3: 'triple',
        4: 'quad'
    };
    
    roomTypeCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            roomTypeCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Update hidden inputs
            const beds = this.dataset.beds;
            bedsInput.value = beds;
            roomTypeInput.value = typeMapping[beds] || 'custom';
        });
    });
    
    // Set initial selection if editing
    if (bedsInput.value) {
        const selectedCard = document.querySelector(`[data-beds="${bedsInput.value}"]`);
        if (selectedCard) {
            selectedCard.classList.add('selected');
        }
    }
    
    // Room numbers handling
    const roomNumbersInput = document.getElementById('{{ form.room_numbers.id_for_label }}');
    const roomNumberTags = document.getElementById('roomNumberTags');
    
    function updateRoomNumberTags() {
        const numbers = roomNumbersInput.value.split(',').map(n => n.trim()).filter(n => n);
        roomNumberTags.innerHTML = '';
        
        numbers.forEach(number => {
            const tag = document.createElement('div');
            tag.className = 'room-tag';
            tag.innerHTML = `
                ${number}
                <button type="button" class="room-tag-remove" onclick="removeRoomNumber('${number}')">
                    <i class="fas fa-times"></i>
                </button>
            `;
            roomNumberTags.appendChild(tag);
        });
    }
    
    roomNumbersInput.addEventListener('input', updateRoomNumberTags);
    updateRoomNumberTags(); // Initial load
    
    // Feature selection
    const featureCards = document.querySelectorAll('.feature-card');
    featureCards.forEach(card => {
        const checkbox = card.querySelector('input[type="checkbox"]');
        
        card.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox') {
                checkbox.checked = !checkbox.checked;
            }
            
            if (checkbox.checked) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
        
        // Set initial state
        if (checkbox.checked) {
            card.classList.add('selected');
        }
    });
    
    // Image upload functionality
    setupImageUpload('mainImageUpload', '{{ form.main_image.id_for_label }}', 'mainImagePreview', false);
    setupImageUpload('additionalImagesUpload', '{{ form.images.id_for_label }}', 'additionalImagesPreview', true);
    
    function setupImageUpload(uploadId, inputId, previewId, multiple) {
        const uploadZone = document.getElementById(uploadId);
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        
        uploadZone.addEventListener('click', () => input.click());
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });
        
        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });
        
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageFiles(files, preview, multiple);
                // Update input files
                input.files = files;
            }
        });
        
        input.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleImageFiles(e.target.files, preview, multiple);
            }
        });
    }
    
    function handleImageFiles(files, previewContainer, multiple) {
        if (!multiple) {
            previewContainer.innerHTML = '';
        }
        
        Array.from(files).forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageItem = document.createElement('div');
                imageItem.className = 'image-item';
                imageItem.innerHTML = `
                    <img src="${e.target.result}" alt="Preview" class="image-preview">
                    <button type="button" class="image-remove" onclick="removeImage(this)">
                        <i class="fas fa-times"></i>
                    </button>
                    ${index === 0 && !multiple ? '<div class="image-main-badge">Main</div>' : ''}
                `;
                previewContainer.appendChild(imageItem);
            };
            reader.readAsDataURL(file);
        });
    }
    
    // Form validation
    const form = document.getElementById('roomTypeForm');
    form.addEventListener('submit', function(e) {
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
        
        // Validate room type selection
        if (!bedsInput.value) {
            e.preventDefault();
            alert('Please select the number of beds per room');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '{% if object %}Update Room Type{% else %}Add Room Type{% endif %} <i class="fas fa-check ms-2"></i>';
            return;
        }
    });
});

function removeRoomNumber(number) {
    const input = document.getElementById('{{ form.room_numbers.id_for_label }}');
    const numbers = input.value.split(',').map(n => n.trim()).filter(n => n && n !== number);
    input.value = numbers.join(',');
    input.dispatchEvent(new Event('input'));
}

function removeImage(button) {
    const imageItem = button.closest('.image-item');
    imageItem.remove();
    
    // Clear the corresponding input if it's the main image
    const previewContainer = imageItem.parentElement;
    if (previewContainer.id === 'mainImagePreview') {
        document.getElementById('{{ form.main_image.id_for_label }}').value = '';
    }
}
</script>
{% endblock %}